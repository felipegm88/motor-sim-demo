name: SCA (CodeChecker)

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  codechecker:
    runs-on: ubuntu-latest
    env:
      ZEPHYR_TOOLCHAIN_VARIANT: host

    steps:
      - name: Checkout (into motor-sim-demo/)
        uses: actions/checkout@v4
        with:
          path: motor-sim-demo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install OS deps (Zephyr + SCA)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ninja-build cmake gperf device-tree-compiler \
            gcc g++ make build-essential libc6-dev linux-libc-dev \
            ccache dfu-util wget python3-dev python3-venv python3-tk \
            xz-utils file gcc-multilib g++-multilib libsdl2-dev libmagic1 \
            clang-tidy clang cppcheck

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install west gcovr CodeChecker

      - name: Init west workspace + fetch Zephyr
        run: |
          west init -l motor-sim-demo
          west update
          pip install -r zephyr/scripts/requirements.txt

      - name: Run CodeChecker (clangsa + clang-tidy)
        working-directory: motor-sim-demo
        run: |
          west build -b native_sim -d build-codechecker --pristine -- \
            -DZEPHYR_SCA_VARIANT=codechecker \
            -DCODECHECKER_EXPORT=html \
            -DCODECHECKER_PARSE_EXIT_STATUS=1 \
            -DCODECHECKER_ANALYZE_OPTS="--analyzers;clangsa;clang-tidy;--skip;${PWD}/.codechecker.skip;--analyzer-config=clang-tidy:cc-verbatim-args-file=${PWD}/.codechecker.tidyargs" \
            -DCODECHECKER_PARSE_OPTS="--skip;${PWD}/.codechecker.skip"

      - name: Upload CodeChecker HTML report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: codechecker-html
          path: motor-sim-demo/build-codechecker/sca/codechecker/codechecker.html

